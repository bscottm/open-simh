# A pipeline is composed of independent jobs that run scripts, grouped into stages.
# Stages run in sequential order, but jobs within stages run in parallel.
#
# For more information, see: https://docs.gitlab.com/ee/ci/yaml/index.html#stages
#
# You can copy and paste this template into a new `.gitlab-ci.yml` file.
# You should not add this template to an existing `.gitlab-ci.yml` file by using the `include:` keyword.
#
# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Getting-Started.gitlab-ci.yml

.shared_windows_runners:
  tags:
    - shared-windows
    - windows-1809
  variables:
    VCPKG_ROOT: C:\vcpkg

.shared_linux_runners:
  tags:
    - saas-linux-small-amd64

stages:
  - build


## ~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=
## The Windows build
## ~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=

cmake-windows-native-build:
  extends:
    - .shared_windows_runners
  stage: build
  script:
    - |
      if (!(Test-Path Env:\VCPKG_ROOT)) {
        New-Item -Force -Path Env:\VCPKG_ROOT -Value ${VCPKG_ROOT}
      }
      pushd ${VCPKG_ROOT}
      git checkout master
      git pull --rebase
      popd
    - .\cmake\cmake-builder.ps1 -flavor vs2019 -config Release -clean -parallel -verbose -cpack_suffix win32-native
    - cd cmake\build-vs2019 && cpack -G "NSIS;WIX;ZIP" -C Release
  artifacts:
    when: on_success
    expire_in: 30 days
    paths:
      - "simh-4.1.0-win32-vs2019.zip"
      - "simh-4.1.0-win32-vs2019.exe"
      - "simh-4.1.0-win32-native.msi"

## ~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=
## Ubuntu 22.04 (jammy)
## ~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=~=

cmake-ubuntu-jammy-build:
  extends:
    - .shared_linux_runners
  image: ubuntu:jammy
  stage: build
  script:
    - apt update && apt -ym upgrade && apt -y autoremove
    - apt install -ym sudo gcc g++ ninja-build git
    - .travis/deps.sh linux
    - cmake/cmake-builder.sh --config Release --flavor ninja --parallel --verbose --cpack_suffix x86_64-ubuntu22.04
    - cd cmake/build-ninja && cpack -G DEB -C Release
  artifacts:
    when: on_success
    expire_in: 30 days
    paths:
      - "simh-4.1.0-x86_64-x86_64-ubuntu22.04.deb"
